#### 1. 인스턴스 생성
---
**`WEB`**
1. 구독: `Azure for Students`
2. 리소스 그룹: (신규) Infra-env
3. VM명: Infra-env-web
4. OS: Ubuntu Server 20.04 LTS
5. 플랜: Standard_B1ls
6. 관리자 계정: infra-admin
7. 키 쌍 이름: infra-env-key-01(RSA SSH)
![[infra-env-key-01.pem]]
8. 네트워크 그룹 설정  (IP: 4.230.0.14)

**`WAS`**
1. 구독: `Azure for Students`
2. 리소스 그룹: Infra-env
3. VM명: Infra-env-was
4. OS: Ubuntu Server 20.04 LTS
5. 플랜: Standard_B1ls
6. 관리자 계정: infra-admin
7. 키 쌍 이름: infra-env-key-01(RSA SSH)
![[infra-env-key-01.pem]]
8. 네트워크 그룹 설정 (IP: 20.39.200.90)

**`DB`**
1. 구독: `Azure for Students`
2. 리소스 그룹: Infra-env
3. VM명: Infra-env-db
4. OS: Ubuntu Server 20.04 LTS
5. 플랜: Standard_B1ls
6. 관리자 계정: infra-admin
7. 키 쌍 이름: infra-env-key-01(RSA SSH)
![[infra-env-key-01.pem]]
8. 네트워크 그룹 설정 (IP: 20.39.204.186)

#### 2. 네트워크 설정
---
**가상 네트워크 토폴로지: Infra-env-web-vnet**
![[Vnet-topology-01.png]]
`Virtural Machine - Network Interface`
`Network Interface - Virtual Machine`
`Network Interface - Ip Config`
`Network Interface - NetworkSecurityGroups`
`Ip Config - Public Ip Address`

#### 3. WEB/WAS/DB 설정
---
##### 1. WEB 설정
1. `Apache 설치
	- `apt-get install apache2`
2. 방화벽 설정
	- `ufw allow 'Apache'`
	- `ufw allow 80/tcp`
```
# Apache 구축
apt-get install apache2
systemctl start apache2
# 방화벽 설정
ufw app list
ufw allow 'Apache'
ufw allow 80/tcp
ufw enable
```
##### 2. WAS 설정
**Spring**
1. JDK 설정 + 환경 변수 설정
2. git clone
3. gradle 빌드
	- [Ref. gradle과 gradlew의 차이점](https://velog.io/@hyeonwoody/Javagradle%EA%B3%BC-gradlew-%EC%B0%A8%EC%9D%B4)
	- 빌드 시 테스트 때문에 타임 아웃 : `./gradlew build -x test`
4. jar 파일 실행
	- nohup java -jar build/libs/Cloud-Demo-0.0.1-SNAPSHOT.jar --server.port=8080 > app.log 2>&1 &
```
# JDK 설정
update-alternatives --config java
# JDK 설치 (17)
apt update
apt install openjdk-17-jdk
java -version
sudo vi /etc/enviroment
{JAVA_HOME="usr/lib/jvm/java-17-openjdk-amd64"}
source /etc/enviroment

# gradle 빌드
./gradlew clean build
# 빌드 시 테스트 제외
./gradlew build -x test

# &, 백그라운드로 실행
java -jar build/libs/Cloud-Demo-0.0.1-SNAPSHOT.jar
nohup java -jar build/libs/Cloud-Demo-0.0.1-SNAPSHOT.jar --server.port=8080 > app.log 2>&1 &
```
##### 3. WEB-WAS 간 설정
- **WEB, `mod_jk` 설정**
	- [Ref. mod_jk 설정](https://velog.io/@sot_sky/mod-jk%EB%A1%9C-Ubuntu22%EC%84%9C%EB%B2%84%EC%97%90%EC%84%9C-%EC%95%84%ED%8C%8C%EC%B9%98-%ED%86%B0%EC%BA%A3-%EC%97%B0%EB%8F%99%ED%95%98%EA%B8%B0)
	```
	apt install libapache2-mod-jk

	[/etc/apache2/apache2.conf]
	# 파일 끝에 추가
	LoadModule jk_module /usr/lib/apache2/modules/mod_jk.so
	JkWorkersFile /etc/apache2/workers.properties
	JkLogFile /var/log/apache2/mod_jk.log
	JkLogLevel info
	JkLogStampFormat "[%a %b %d %H:%M:%S %Y]"
	
	[/etc/apache2/workers.properties] : 기존 workers.properties 사용하지 않고 새로운 파일 생성
	worker.list=worker1
	
	worker.worker1.type=ajp13
	worker.worker1.host=10.0.0.5
	worker.worker1.port=8009
	worker.worker1.lbfactor=1

	[/etc/apache/sites-available/000-default.conf]
	<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    # Spring Boot 애플리케이션으로 라우팅
    JkMount /* worker1

    # 정적 파일은 Apache가 처리
    JkUnMount /static/* worker1
    JkUnMount /images/* worker1
    JkUnMount /css/* worker1
    JkUnMount /js/* worker1

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
	</VirtualHost>
	```
- **WAS, 소스 설정**
```
# application.properties 수정
server.port=8080
tomcat.ajp.port=8009
tomcat.ajp.remoteauthentication=false
tomcat.ajp.enabled=true
tomcat.ajp.address=0.0.0.0

# Config 클래스 추가
package com.practice.clouddemo.util;

import org.apache.catalina.connector.Connector;
import org.apache.coyote.ajp.AbstractAjpProtocol;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory;
import org.springframework.boot.web.servlet.server.ServletWebServerFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class ContainerConfiguration {
    
    @Value("${tomcat.ajp.port}")
    int ajpPort;
    
    @Value("${tomcat.ajp.protocol}")
    String ajpProtocol;
    
    @Value("${tomcat.ajp.enabled}")
    boolean tomcatAjpEnabled;

    @Value("${tomcat.ajp.address}")
    String address;

    @Value("${tomcat.ajp.allowedRequestAttributesPattern}")
    String allowedRequestAttributesPattern;
    
    @Bean
    public ServletWebServerFactory servletContainer() {
        TomcatServletWebServerFactory tomcat = new TomcatServletWebServerFactory();
        tomcat.addAdditionalTomcatConnectors(createAjpConnector());
        
        return tomcat;
    }

    private Connector createAjpConnector() {
        Connector ajpConnector = new Connector(ajpProtocol);
        ajpConnector.setProperty("address",address);
        ajpConnector.setProperty("allowedRequestAttributesPattern", allowedRequestAttributesPattern);

        ajpConnector.setPort(ajpPort);
        ajpConnector.setSecure(false);
        ajpConnector.setAllowTrace(false);
        ajpConnector.setScheme("http");

        ((AbstractAjpProtocol<?>) ajpConnector.getProtocolHandler()).setSecretRequired(false);

        return ajpConnector;
    }
}
```

### 현재까지 트러블 슈팅
1. WEB, WAS의 포트를 뚫어주지 않아도 서로 통신이 된다. (같은 가상네트워크)
2. $JAVA_HOME 변수 지정할 때, 맨 앞에 / 빼먹어서 1시간 삽질함
3. ./gradlew 는 gradle을 설치할 필요 없이 사용 가능
4. ./gradlew build -x test로 테스트를 제외하고 빌드, (VM 메모리가 작아서 그런지 테스트까지 돌리면 타임 아웃 발생)
5. `netstat -nltp`로 포트 확인
### 부가 목표
1. WEB, WAS 인스턴스 추가해서 mod_jk로 로드밸런싱 혹은 클라우드 로드밸런싱
2. WAS 공인IP 제거하고 인터넷 끊기

##### 3. WAS-DB 간 설정
[Ref. MySQL 구축 - Ubuntu](https://jongsky.tistory.com/79)
- **MySQL 구축**
```
# Mysql 설치
apt install mysql-server-8.0
# 방화벽 포트오픈 (3306)
sudo ufw allow mysql
# daemon start
systemctl start mysql
# 재시작 시 자동 재시작
systemctl enable mysql

# 접속 후 root 계정 설정
mysql -u root
ALTER USER 'root'@'localhost' IDENTIFIED BY 'infraadmin';
FLUSH PRIVILEGES;
# 현재 계정 정보 확인
SELECT Host,User,plugin,authentication_string FROM mysql.user;
```
- **테스트를 위한 데이터베이스 생성 + 테스트 계정 생성**
```
CREATE DATABASE infra_env;

CREATE USER 'infra_admin'@'10.0.0.5' IDENTIFIED BY 'infraadmin';
GRANT ALL PRIVILEGES ON infra_env.* TO 'infra_admin'@'10.0.0.5';
FLUSH PRIVILEGES;
```
- MySQL 접속을 위한 IP 설정 및 재시작
```
vi /etc/mysql/mysql.conf.d/mysqld.cnf
	bind-address = 0.0.0.0
```

- **소스코드 설정**
```
spring.jpa.database=mysql
spring.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/infra_env?serverTimezone=Asia/Seoul
spring.datasource.username=infra_admin
spring.datasource.password=infraadmin
```
#### 4. Jenkis
---